import{d as o}from"./datafeed-d62ae98f.js";import{u as h}from"./market-8356724b.js";import{_ as c}from"./bootstrap-249b0f62.js";import"./_commonjsHelpers-de833af9.js";import"./dijkstra-f906a09e.js";import"./preload-helper-f61836a9.js";import"./axios-7a713374.js";const l={binance:["1","3","5","15","30","60","120","240","360","480","720","D","W","M"],binanceus:["1","3","5","15","30","60","120","240","360","480","720","D","W","M"],kucoin:["1","5","15","30","60","240","D","W","M"],bitget:["1","5","15","30","60","240","360","720","D","W"]},n=l[provider],m={binance:{"1m":"1","3m":"3","5m":"5","15m":"15","30m":"30","1h":"60","2h":"120","4h":"240","6h":"360","8h":"480","12h":"720","1d":"D",w:"W",m:"M"},binanceus:{"1m":"1","3m":"3","5m":"5","15m":"15","30m":"30","1h":"60","2h":"120","4h":"240","6h":"360","8h":"480","12h":"720","1d":"D",w:"W",m:"M"},kucoin:{"1m":"1","5m":"5","15m":"15","30m":"30","1h":"60","4h":"240","1d":"D",w:"W",m:"M"},bitget:{"1m":"1","5m":"5","15m":"15","30m":"30","1h":"60","4h":"240","6h":"360","12h":"720","1d":"D",w:"W"}},u={1:864e5,3:2592e5,5:432e6,15:1296e6,30:2592e6,60:5184e6,120:10368e6,240:20736e6,320:31104e6,480:41472e6,720:62208e6,D:165888e6,W:1161216e6,M:497664e7},i=m[provider],p={name:"KLineWidget",setup(){return{marketStore:h()}},data(){return{interval:"1h",ws:null,since:null,widget:null,duration:864e5,now:Date.now(),lastprice:[],pair:this.$route.params.symbol+"/"+this.$route.params.currency,datafeed:new o.DataFeed({getBars:e=>this.getBars(e),fetchResolveSymbol:()=>this.resolveSymbol(),fetchConfiguration:()=>new Promise(e=>{e({supported_resolutions:n})})})}},created(){},mounted(){this.initTradingView(),this.parentHeight=this.$parent.$el.offsetHeight},methods:{resolveSymbol(){return new Promise(e=>{var t=this.$route.params.symbol+"/"+this.$route.params.currency;this.marketStore.bestAsk,e({name:t,full_name:t,description:t,type:t,session:"24x7",pricescale:[1,1,100],exchange:gnl.sitename.toUpperCase(),listed_exchange:gnl.sitename.toUpperCase(),timezone:"Etc/UTC",format:"price",minmov:1,has_intraday:!0,supported_resolutions:n,volume_precision:2,data_status:"streaming",pricescale:100})})},async getBars(e){if(!e.firstDataRequest)return{bars:[],meta:{noData:!0}};if(e.resolution!==i[this.interval]){this.unsubscribeKLine();for(let s in i)i[s]===e.resolution&&(this.interval=s)}const t=await this.getKLine(this.$route.params.symbol+"/"+this.$route.params.currency);if(e.resolution===i[this.interval]&&e.firstDataRequest&&t&&t.length&&this.subscribeKLine(this.$route.params.symbol+"/"+this.$route.params.currency),!t||!t.length)return{bars:[],meta:{noData:!0}};const r=[];for(let s=0;s<t.length;s++){const a=t[s];r.push({time:a[0],open:a[1],high:a[2],low:a[3],close:a[4],volume:a[5]})}return r.sort((s,a)=>s.time>a.time?1:-1),{bars:r,meta:{noData:!r.length}}},getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e},getKLine(e){this.duration=u[i[this.interval]]||0;let t=1e3;switch(provider){case"binance":this.since=this.now-this.duration/3,t=500;break;case"kucoin":this.since=this.now-this.duration,t=1500;break;case"bitget":this.since=this.now-this.duration/1.5,t=1e3;break;default:this.since=this.now-this.duration,t=1e3;break}try{return this.marketStore.exchange.fetchOHLCV(e,this.interval,this.since,t)}catch(r){if(console.log(r.constructor.name,r.message),r.constructor.name==419)return this.marketStore.exchange.fetchOHLCV(e,this.interval,this.since)}},handleTick(e){const t=document.getElementById("favicon");this.datafeed.updateKLine({time:e[0],open:e[1],high:e[2],low:e[3],close:e[4],volume:e[5]}),!this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]||e[4]>this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]?(document.title=e[4]+" | "+this.$route.params.symbol+"/"+this.$route.params.currency,t.href="/assets/up.png"):e[4]<this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]?(document.title=e[4]+" | "+this.$route.params.symbol+"/"+this.$route.params.currency,t.href="/assets/down.png"):t.href="/assets/neutral.png",this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]=e[4]},async subscribeKLine(){let e=[];for(;window.location.href.indexOf(this.$route.params.symbol+"/"+this.$route.params.currency)>-1;)try{e[this.$route.params.symbol+"/"+this.$route.params.currency]=await this.marketStore.exchange.watchOHLCV(this.$route.params.symbol+"/"+this.$route.params.currency,this.interval),this.handleTick(e[this.$route.params.symbol+"/"+this.$route.params.currency][e[this.$route.params.symbol+"/"+this.$route.params.currency].length-1])}catch{break}},async unsubscribeKLine(){const e=this.marketStore.exchange.clients[Object.keys(this.marketStore.exchange.clients)[Object.keys(this.marketStore.exchange.clients).length-1]];for(var t in e.subscriptions){const r={id:this.getRandomInt(0,1e3).toString(),type:"unsubscribe",topic:t,privateChannel:!1,response:!0};e.send(r)}},initTradingView(){const e=document.getElementById("tv_chart_container");e&&e.remove();const t=document.createElement("div");t.id="tv_chart_container",t.style.height="100%",document.querySelector("#creatable").appendChild(t);var s=this.$route.params.symbol+"/"+this.$route.params.currency;this.widget=new o.widget({fullscreen:!1,width:"100%",height:"100%",symbol:s,interval:i[this.interval],container_id:"tv_chart_container",datafeed:this.datafeed,library_path:"/charting_library/",locale:"en",theme:theme=="dark"?"Dark":"Light",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,allow_symbol_change:!1,charts_storage_api_version:"1.1",client_id:"chart",toolbar_bg:"#1F2937",disabled_features:["header_compare","study_dialog_search_control","symbol_search_hot_key","header_symbol_search","go_to_date","compare_symbol","timezone_menu","timeframes_toolbar"],enabled_features:["dont_show_boolean_study_arguments","use_localstorage_for_settings","save_chart_properties_to_local_storage","side_toolbar_in_fullscreen_mode","hide_last_na_study_output","constraint_dialogs_movement","hide_left_toolbar_by_default"]})},setSymbol(e){this.unsubscribeKLine(),this.symbol=e,this.widget.setSymbol(e,i[this.interval],()=>{console.log("------setSymbol---------",this.symbol)})}}};function d(e,t,r,s,a,_){return null}const D=c(p,[["render",d]]);export{D as default};
